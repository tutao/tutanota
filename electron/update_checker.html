<html>
<head>
    <title>Tutanota Update Checcker</title>
    <style>
        .message_log{
            display: table;
            height: 100%;
            width: 100%;
            text-align: center;
        }
        .message_log span{
            display: table-cell;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="message_log">
        <span>If you see this message, something is wrong.</span>
    </div>

    <!-- FIX for electron -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- SCRIPT -->
    <script>
        const path = require('path');
        var http = require('http');
        var app  = require('electron').remote.app;
        var fs = require('fs');

        var new_files_list = [];
        var old_files_list = [];
        var files_updated = 0;

        $(".message_log").html("<span>Checking for updates...</span>");
        $.ajax({
            dataType: "json",
            url: "http://raw.githubusercontent.com/zeeshan595/tutanota/tutanota-latest-electron-build/md5sum.json",
            data: "",
            success: function(data){
                new_files_list = data['md5sum'];
                $.ajax({
                    dataType: "json",
                    url: path.join(__dirname, 'md5sum.json'),
                    data: "",
                    success: function(data){
                        old_files_list = data['md5sum'];
                        CompareFiles();
                    },
                    error: function (request, status, error) {
                        old_files_list = [];
                        CompareFiles();
                    }
                });
            },
            error: function (request, status, error) {
                new_files_list = [];
                alert("ERROR: Could not get file list from server.");
            }
        });

        function CompareFiles()
        {
            for (var i = 0; i < new_files_list.length; i++)
            {
                $(".message_log").html("<span>Updating: " + i + "/" + new_files_list.length + "</span>");
                
                var frequired = true;
                for (var j = 0; j < old_files_list.length; j++)
                {
                    if (new_files_list[i].file == old_files_list[i].file)
                    {
                        if (new_files_list[i].size == old_files_list[i].size)
                        {
                            frequired = false;
                        }
                    }
                }

                if (frequired)
                {
                    DownloadFile(new_files_list[i].file);
                }
            }
        }

        function DownloadFile(file_path)
        {
            const url = new URL("http://raw.githubusercontent.com/zeeshan595/tutanota/tutanota-latest-electron-build/" + file_path);
            var full_path = path.join(__dirname, file_path);
            //Create Dir if does not exist
            var file_dir = full_path.substring(0, full_path.lastIndexOf("/") + 1);
            if (file_dir != "" && !fs.existsSync(file_dir))
            {
                    fs.mkdirSync(file_dir);
            }

            var file_data = "";
            var request = http.get(url, (res) => {
                res.setEncoding('utf8');
                res.on('data', (chunk) => {
                    file_data += chunk;
                });
                res.on('end', () => {
                    //Remove existing file if it exists 
                    fs.unlink(full_path, function(err){ 
                        // Ignore error if no file already exists 
                        if (err && err.code !== 'ENOENT') 
                        { 
                            throw err; 
                        } 
                            
                        //Save the downloaded file 
                        var options = { flag : 'w' }; 
                        fs.writeFile(full_path, file_data, options, function(err) { 
                            if (err) throw err; 
                            console.log('Downloaded:' + full_path );
                            files_updated++;
                        }); 
                    });
                    files_updated++;
                    if ((files_updated + 1) == old_files_list.length)
                    {
                        //Open Application
                        window.location.href = "index.html";
                    }
                });
            });
        }
    </script>
    <!-- FIX for electron -->
	<script>if (window.module) module = window.module;</script>	
</body>
</html>