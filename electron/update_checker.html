<html>
<head>
    <title>Tutanota Update Checcker</title>
    <style>
        .message_log{
            display: table;
            height: 100%;
            width: 100%;
            text-align: center;
        }
        .message_log span{
            display: table-cell;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="message_log">
        <span>If you see this message, something is wrong.</span>
    </div>

    <!-- FIX for electron -->
    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- SCRIPT -->
    <script>
        const path = require('path');
        var fs = require('fs');

        var new_files_list = [];
        var old_files_list = [];
        $(".message_log").html("<span>Checking for updates...</span>");
        $.ajax({
            dataType: "json",
            url: "http://raw.githubusercontent.com/zeeshan595/tutanota/tutanota-latest-electron-build/md5sum.json",
            data: "",
            success: function(data){
                new_files_list = data['md5sum'];
                $.ajax({
                    dataType: "json",
                    url: path.join(__dirname, 'md5sum.json'),
                    data: "",
                    success: function(data){
                        old_files_list = data['md5sum'];
                        CompareFiles();
                    },
                    error: function (request, status, error) {
                        old_files_list = [];
                        CompareFiles();
                    }
                });
            },
            error: function (request, status, error) {
                new_files_list = [];
                alert("ERROR: Could not get file list from server.");
            }
        });

        function CompareFiles()
        {
            for (var i = 0; i < new_files_list.length; i++)
            {
                $(".message_log").html("<span>Updating: " + i + "/" + new_files_list.length + "</span>");
                
                var frequired = true;
                for (var j = 0; j < old_files_list.length; j++)
                {
                    if (new_files_list[i].file == old_files_list[i].file)
                    {
                        if (new_files_list[i].size == old_files_list[i].size)
                        {
                            frequired = false;
                        }
                    }
                }

                if (frequired)
                {
                    DownloadFile(new_files_list[i].file)
                }
            }
            //Open Application
            window.location.href = "index.html";
        }

        function DownloadFile(file_path)
        {
            //Create Dir if does not exist
            var file_dir = file_path.substring(0, file_path.lastIndexOf("/") + 1);
            if (file_dir != "" && !fs.existsSync(file_dir))
            {
                    fs.mkdirSync(file_dir);
            }

            //Download required file
            $.ajax({
                dataType: "text",
                url: "http://raw.githubusercontent.com/zeeshan595/tutanota/tutanota-latest-electron-build/" + file_path,
                data: "",
                success: function(data){
                    //Remove existing file if it exists
                    fs.unlink(file_path, function(err){
                        // Ignore error if no file already exists
                        if (err && err.code !== 'ENOENT')
                        {
                            throw err;
                        }
                        
                        //Save the downloaded file
                        var options = { flag : 'w' };
                        fs.writeFile(file_path, data, options, function(err) {
                            if (err) throw err;
                            console.log('Downloaded:' + file_path );
                        });
                    });
                },
                error: function (request, status, error) {
                    alert("ERROR: Could not get file: " + file_path);
                }
            });
        }
    </script>
    <!-- FIX for electron -->
	<script>if (window.module) module = window.module;</script>	
</body>
</html>